<link rel="stylesheet" href="/src/index.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<div id="controls" class="inline-block bg-gray-700 text-white text-lg p-2 rounded-lg space-x-3">
    <button id="previous" class="hover:scale-125 focus:outline-none">
        <i class="fa fa-backward"></i>
    </button>
    <button id="stop" class="hidden hover:scale-125 focus:outline-none">
        <i class="fa fa-stop"></i>
    </button>
    <button id="play" class="group hover:scale-125 focus:outline-none">
        <i class="group-[.playing]:hidden fa fa-play"></i>
        <div class="hidden group-[.playing]:inline">
            <i class="fa fa-pause"></i>
        </div>
    </button>
    <button id="next" class="hover:scale-125 focus:outline-none">
        <i class="fa fa-forward"></i>
    </button>
    <button id="toggleoptions" class="hover:scale-125 focus:outline-none">
        <i class="fa fa-sliders"></i>
    </button>
</div>

<div id="options"
    class="hidden fixed top-80 left-1/2 -translate-x-1/2 flex-wrap bg-gray-800 text-white rounded-lg shadow-2xl shadow-black p-3">
    <div class="p-2">
        <label for="speed">Speed:</label>
        <select id="speed" class="bg-gray-700 focus:outline-none">
            <option value="0.5">0.5x</option>
            <option value="1" selected>1x</option>
            <option value="1.5">1.5x</option>
            <option value="2">2x</option>
        </select>
    </div>

    <div class="p-2">
        <label for="voices">Voices:</label>
        <select id="voices" class="bg-gray-700 focus:outline-none w-80"></select>
    </div>
</div>
<script>
    console.log('hello')
    document.addEventListener('DOMContentLoaded', function () {
        var lines = document.querySelectorAll("#content p, #content h1, #content h2, #content h3, #content h4, #content h5, #content h6, #content h7");

        var currentIndex = 0;
        var currentCharacter = 0;
        var isPlaying = false;
        var utterance = new SpeechSynthesisUtterance();

        utterance.addEventListener('boundary', function (e) {
            currentCharacter = e.charIndex;
        });

        document.addEventListener('click', function (e) {
            if (!e.target.closest('#toggleoptions, #options')) {
                document.getElementById('options').classList.add('hidden');
            }
        });

        document.getElementById('toggleoptions').addEventListener('click', function () {
            document.getElementById('options').classList.toggle('hidden');
        });

        function initialize() {
            document.getElementById('speed').addEventListener('change', function () {
                var speed = parseFloat(this.value);
                utterance.rate = speed;
                update();
            });

            document.getElementById('voices').addEventListener('change', function () {
                var selectedVoiceIndex = this.value;
                var voices = speechSynthesis.getVoices();
                utterance.voice = voices[selectedVoiceIndex];
                update();
            });

            document.getElementById('play').addEventListener('click', play);
            document.getElementById('next').addEventListener('click', next);
            document.getElementById('previous').addEventListener('click', previous);

            document.addEventListener('keydown', function (e) {
                e.preventDefault();
                if (e.which === 32 || e.which === 179) {
                    play();
                } else if (e.which === 39 || e.which === 176) {
                    next();
                } else if (e.which === 37 || e.which === 177) {
                    previous();
                }
            });

            document.getElementById('stop').addEventListener('click', function () {
                speechSynthesis.cancel();
                isPlaying = false;
                lines.forEach(function (line) {
                    line.classList.remove('bg-sky-200');
                });
                document.getElementById('controls').classList.remove('fixed', 'bottom-2','right-1/2', 'translate-x-1/2');
                document.getElementById('stop').classList.add('hidden')
                document.getElementById('play').classList.remove('playing');
                currentIndex = 0;
                currentCharacter = 0;
            });
        }

        if ('speechSynthesis' in window && 'SpeechSynthesisUtterance' in window) {
            initialize();
        } else {
            alert('Text-to-speech is not supported in this browser.');
        }

        function update() {
            var currentLine = lines[currentIndex];
            lines.forEach(function (line) {
                line.classList.remove('bg-sky-200');
            });
            currentLine.classList.add('bg-sky-200');

            window.scrollTo({
                top: currentLine.offsetTop - 200,
                behavior: 'smooth'
            });

            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                speakLine();
            } else {
                speechSynthesis.cancel();
            }
        }

        function speakLine() {
            var currentLine = lines[currentIndex];
            var text = currentLine.textContent;
            utterance.text = text.substring(currentCharacter);
            speechSynthesis.speak(utterance);

            utterance.onend = function () {
                if (currentIndex < lines.length - 1) {
                    currentIndex++;
                    currentCharacter = 0;
                    speakLine();
                    update();
                }
            };
        }

        function play() {
            populateVoices();
            isPlaying = !isPlaying;
            document.getElementById('play').classList.toggle('playing');
            if (isPlaying) {
                var selectedVoiceIndex = document.getElementById('voices').value;
                var voices = speechSynthesis.getVoices();
                utterance.voice = voices[selectedVoiceIndex];
                var selectedSpeed = parseFloat(document.getElementById('speed').value);
                utterance.rate = selectedSpeed;
                document.getElementById('controls').classList.add('fixed', 'bottom-2','right-1/2', 'translate-x-1/2');
                document.getElementById('stop').classList.remove('hidden')
                speakLine();
                update();
            } else {
                speechSynthesis.cancel();
            }
        }

        function previous() {
            if (currentIndex > 0) {
                currentIndex--;
                currentCharacter = 0;
                update();
            }
        }

        function next() {
            if (currentIndex < lines.length - 1) {
                currentIndex++;
                currentCharacter = 0;
                update();
            }
        }

        function populateVoices() {
            var voices = speechSynthesis.getVoices();
            var voicesSelect = document.getElementById('voices');
            voicesSelect.innerHTML = '';

            voices.forEach(function (voice, index) {
                var option = document.createElement('option');
                option.value = index;
                option.textContent = voice.name;
                voicesSelect.appendChild(option);
            });
        }
    });

</script>